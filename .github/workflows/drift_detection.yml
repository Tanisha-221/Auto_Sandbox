name: 'Drift Detection Pipeline'

on:
  push:
    branches:
      - "main"
  workflow_dispatch:
    inputs:
      vm_count:
        description: "Virtual Machine count"
        default: 1
        required: true
      prefix:
        description: "Virtual Machine prefix"
        required: true
        default: "T_Sandbox"

permissions:
  contents: read
  actions: read
  packages: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        shell: bash
        working-directory: ./tf_Config

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init

      - name: Terraform Format
        run: terraform fmt -check

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Extract Azure credentials
        run: |
          SUBSCRIPTION_ID=$(jq -r '.subscriptionId' <<< '${{ secrets.AZURE_CREDENTIALS }}')
          CLIENT_ID=$(jq -r '.clientId' <<< '${{ secrets.AZURE_CREDENTIALS }}')
          CLIENT_SECRET=$(jq -r '.clientSecret' <<< '${{ secrets.AZURE_CREDENTIALS }}')
          TENANT_ID=$(jq -r '.tenantId' <<< '${{ secrets.AZURE_CREDENTIALS }}')
          ADMIN_USERNAME=$(jq -r '.adminUsername' <<< '${{ secrets.ADMINUSERNAME }}')
          ADMIN_PASSWORD=$(jq -r '.adminPassword' <<< '${{ secrets.ADMINPASSWORD }}')

          echo "::add-mask::$SUBSCRIPTION_ID"
          echo "::add-mask::$CLIENT_ID"
          echo "::add-mask::$CLIENT_SECRET"
          echo "::add-mask::$TENANT_ID"
          echo "::add-mask::$ADMIN_USERNAME"
          echo "::add-mask::$ADMIN_PASSWORD"

          echo "ARM_SUBSCRIPTION_ID=$SUBSCRIPTION_ID" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=$CLIENT_ID" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$CLIENT_SECRET" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$TENANT_ID" >> $GITHUB_ENV
          echo "ARM_ADMIN_USERNAME=$ADMIN_USERNAME" >> $GITHUB_ENV
          echo "ARM_ADMIN_PASSWORD=$ADMIN_PASSWORD" >> $GITHUB_ENV

      - name: Terraform Plan - Drift Detection
        env:
          TF_VAR_adminUsername: ${{ secrets.ADMIN_USERNAME }}
          TF_VAR_adminpassword: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          mkdir -p artifacts
          set +e

          terraform plan \
            -refresh-only \
            -var="vm_count=${{ github.event.inputs.vm_count || 1 }}" \
            -var="prefix=${{ github.event.inputs.prefix || 'T_Sandbox' }}" \
            -detailed-exitcode \
            -out=artifacts/tfplan.out

          EXIT_CODE=$?
          echo "Terraform exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" -eq 1 ]; then
            echo "Terraform plan failed"
            exit 1
          fi

          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "Drift detected"
            echo "DRIFT_DETECTED=true" >> $GITHUB_OUTPUT
          else
            echo "No drift detected"
            echo "DRIFT_DETECTED=false" >> $GITHUB_OUTPUT
          fi

          exit 0

      - name: Upload Terraform Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ./tf_Config/artifacts/tfplan.out

    outputs:
      DRIFT_DETECTED: ${{ steps.drift_plan.outputs.DRIFT_DETECTED }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    # Apply only if drift was detected
    if: needs.build.outputs.DRIFT_DETECTED == 'true'

    defaults:
      run:
        shell: bash
        working-directory: ./tf_Config

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Download Terraform Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ./tf_Config/artifacts

      - name: Terraform Apply
        env:
          TF_VAR_adminUsername: ${{ secrets.ADMIN_USERNAME }}
          TF_VAR_adminpassword: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          test -f artifacts/tfplan.out || { echo "Plan file missing"; exit 1; }
          terraform apply -input=false -auto-approve ./tf_config/artifacts/tfplan.out