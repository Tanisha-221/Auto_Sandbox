name: 'Drift Detection Pipeline'

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        shell: bash
        working-directory: ./tf_Config

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Set Terraform variables using environment variables
      - name: Set Terraform Environment Variables
        run: echo "Terraform env vars set"
        env:
          TF_VAR_adminUsername: ${{ fromJson(secrets.ADMINUSERNAME).adminUsername }}
          TF_VAR_adminpassword: ${{ fromJson(secrets.ADMINPASSWORD).adminPassword }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
          ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}

      # Drift detection using a single Terraform plan
      - name: Drift Detection (Terraform Plan)
        id: drift
        run: |
          set +e
          mkdir -p artifacts
          
          terraform plan -refresh-only -detailed-exitcode -input=false -out=artifacts/tfplan.out \
          -var="adminUsername=${{ secrets.ADMINUSERNAME }}" \
          -var="adminpassword=${{ secrets.ADMINPASSWORD }}"
          EXIT_CODE=$?

          # Generate JSON for reporting (optional)
          terraform show -json artifacts/tfplan.out > artifacts/tfplan.json

          if [ $EXIT_CODE -eq 2 ]; then
            echo "DRIFT_DETECTED=true" | tee artifacts/drift-detection.txt
            echo "DRIFT_DETECTED=true" >> $GITHUB_ENV
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "DRIFT_DETECTED=false" | tee artifacts/drift-detection.txt
            echo "DRIFT_DETECTED=false" >> $GITHUB_ENV
          else
            exit 1
          fi

      - name: Upload Drift Detection Result
        uses: actions/upload-artifact@v4
        with:
          name: drift-detection-result
          path: artifacts/drift-detection.txt

      - name: Send Notification on Slack
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,workflow,job,ref,sha
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}